<!-- This page now *extends* base.html -->
{% extends "base.html" %}

{% block title %}Dashboard - eApproval{% endblock %}

{% block content %}
<div class="container">
    <h2>Welcome, {{ current_user.username }} ({{ current_user.role.replace('_',' ').title() }})</h2>
    
    <!-- 
    The 'Create New' and 'Logout' links are now in the header 
    from base.html, so we can remove the old .top-links div.
    -->

    <h3>Requests</h3>
    <table class="dashboard-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Created By</th>
                <th>Class Teacher</th>
                <th>HOD</th>
                <th>Principal</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for req in requests %}
            <tr>
                <td>{{ req.id }}</td>
                <td>{{ req.title }}</td>
                <td>{{ req.creator.username }}</td>

                <!-- Status pills now use the 'status' class and a dynamic class -->
                <td><span class="status {{ req.class_teacher_status }}">{{ req.class_teacher_status }}</span></td>
                <td><span class="status {{ req.hod_status }}">{{ req.hod_status }}</span></td>
                <td><span class="status {{ req.principal_status }}">{{ req.principal_status }}</span></td>

                <td class="action-buttons">
                    <!-- Always show View -->
                    <a class="btn btn-secondary" href="{{ url_for('view_request', req_id=req.id) }}">üëÅ View</a>

                    <!-- Approval buttons -->
                    {% if current_user.role == 'class_teacher' and req.class_teacher_status == 'Pending' %}
                        <form action="{{ url_for('approve_request', req_id=req.id) }}" method="post">
                            <button class="btn btn-success" type="submit">Approve</button>
                        </form>
                        <form action="{{ url_for('reject_request', req_id=req.id, role='class_teacher') }}" method="post">
                            <button class="btn btn-danger" type="submit">Reject</button>
                        </form>
                    {% elif current_user.role == 'hod' and req.class_teacher_status == 'Approved' and req.hod_status == 'Pending' %}
                        <form action="{{ url_for('approve_request', req_id=req.id) }}" method="post">
                            <button class="btn btn-success" type="submit">Approve</button>
                        </form>
                        <form action="{{ url_for('reject_request', req_id=req.id, role='hod') }}" method="post">
                            <button class="btn btn-danger" type="submit">Reject</button>
                        </form>
                    {% elif current_user.role == 'principal' and req.hod_status == 'Approved' and req.principal_status == 'Pending' %}
                        <form action="{{ url_for('approve_request', req_id=req.id) }}" method="post">
                            <button class="btn btn-success" type="submit">Approve</button>
                        </form>
                        <form action="{{ url_for('reject_request', req_id=req.id, role='principal') }}" method="post">
                            <button class="btn btn-danger" type="submit">Reject</button>
                        </form>
                    {% endif %}

                    <!-- PDF download -->
                    {% if req.principal_status == 'Approved' %}
                        <a class="btn btn-pdf" href="{{ url_for('generate_pdf', req_id=req.id) }}">üìÑ PDF</a>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 20px;">No requests found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
